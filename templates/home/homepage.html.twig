{% extends 'base.html.twig' %}

{% block body %}
<h1>{{ title }}</h1>
{# TODO: add an image of the record #}
<div>
    <a type="button" href="{{ path('app_homepage', {
        year: year,
        month: month,
        monthChange: 'last'
    }) }}" class="btn btn-primary">Last month</a>
    Shown: <strong>{{ monthName }}.{{ year }}</strong>.
    <a type="button" href="{{ path('app_homepage', {
        year: year,
        month: month,
        monthChange: 'next'
      }) }}"class="btn btn-success">Next month</a>
    <a type="button" href="{{ path('app_homepage') }}" class="btn btn-secondary">Current month</a>
</div>
<div id="calendar_container">
  <table id="calendar">
    <thead>
      <tr>
        <th>Hour</td>
        {% for day in days %}
            {% set todayClass = day|date('Y-m-d') is same as(today|date('Y-m-d')) ? 'today' : '' %}
            <th class="{{ todayClass }}">
              {{ day|date('d') }}.{{ day|date('m') }} - {{ day|date('D') }}
            </th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
        {% for hour in reservationHours %}
            <tr>
                <td class="calendar-hour">
                  {{ hour }} - {{ hour + 1 }}
                </td>
                {% for day in days %}
{#                    {{ day|date('d-m-Y') }}#}
                    {% set dateKey = day|date('Y-m-d') %}
                    {% set hourTwoChars = "%02d"|format(hour) %}
                    {% set resTimeSuffix = dateKey ~ '-' ~ hourTwoChars %}
                    {% set isReservation = false %}
                    {% set resHourIndex = null %}
                    {% if reservations[dateKey] is defined %}
                        {% for resKey, resHour in reservations[dateKey] %}
                            {% if resHour['hour'] is defined and (hour is same as(resHour['hour'])) %}
                                {% set resHourIndex = resKey %}
                                {% set isReservation = true %}
                                {% set break = true %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    {% set todayClass = dateKey is same as(today|date('Y-m-d')) ? 'today' : '' %}
                    <td class="{{ todayClass }}">
                        {% if false %}
                            <i class="fas fa-stop-circle"></i>
                        {% endif %}
                        {% if not isReservation %}
                            <a class="fas fa-edit"
                               title="Reserve an hour at {{ dateKey }}-{{ "%02d"|format(hour) }}."
                               href="{{ path('app_reservation_add_one', {"year": day|date('Y'), "month": day|date('m'), "day": day|date('d'), "hour": hour}) }}">
                            </a>
                        {% endif %}
                        {% if isReservation %}
                            <div class="reservation_info">
                                <a href="#" id="res_info_link_{{ resTimeSuffix }}">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% set user = reservations[dateKey][resHourIndex] %}
                                <input type="hidden" id="user_name_{{ resTimeSuffix }}" value="{{ user['userAtName'] }}">
                                <input type="hidden" id="user_email_{{ resTimeSuffix }}" value="{{ user['userAtEmail'] }}">
                                <input type="hidden" id="user_phone_{{ resTimeSuffix }}" value="{{ user['userAtPhone'] }}">
                            </div>
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
        {% endfor %}
    </tbody>
  </table>
  
  <div class="modals">
    <dialog class="dialog" id="modal-reservation">
      <div class="dialog__wrapper">
        <button class="dialog__close">âœ•</button>
        <p>Reservation at <strong><span id="modal_res_time"></span></strong> o'clock.</p>
        <p>Patient:</p>
        <ul>
          <li>Name: <strong><span id="modal_user_name"></span></strong></li>
          <li>Email: <strong><span id="modal_user_email"></span></strong></li>
          <li>Phone: <strong><span id="modal_user_phone"></span></strong></li>
        </ul>
      </div>
    </dialog>
  </div>
</div>
{% endblock %}